<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jumpy Bird - 8-bit Retro</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Courier New', monospace;
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 83%, #228B22 83%, #228B22 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .game-container {
            width: 800px;
            height: 600px;
            position: relative;
            border: 3px solid #000;
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 83%, #228B22 83%, #228B22 100%);
            overflow: hidden;
        }

        .buildings {
            position: absolute;
            bottom: 100px;
            width: 100%;
            height: 200px;
            z-index: 1;
        }

        .building {
            position: absolute;
            background: #808080;
            bottom: 0;
        }

        .clouds {
            position: absolute;
            top: 0;
            width: 100%;
            height: 170px;
            z-index: 2;
        }

        .cloud {
            position: absolute;
            background: #FFFFFF;
            border-radius: 40px;
            opacity: 0.9;
            border: 2px solid #E6E6FA;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        .cloud::before,
        .cloud::after {
            content: '';
            position: absolute;
            background: #FFFFFF;
            border-radius: 30px;
            border: 1px solid #E6E6FA;
        }

        .cloud::before {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 10px;
        }

        .cloud::after {
            width: 60px;
            height: 60px;
            top: -30px;
            right: 15px;
        }

        .ground-stripes {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100px;
            background: repeating-linear-gradient(
                90deg,
                #228B22 0px,
                #228B22 20px,
                #006400 20px,
                #006400 40px
            );
            animation: moveStripes 1.5s linear infinite;
            z-index: 3;
        }

        .ground-stripes.paused {
            animation-play-state: paused;
        }

        @keyframes moveStripes {
            0% { transform: translateX(0); }
            100% { transform: translateX(-40px); }
        }

        .auth-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(135, 206, 235, 0.95);
        }

        .title {
            font-size: 48px;
            font-weight: bold;
            color: #000;
            text-shadow: 3px 3px 0px #808080;
            margin-bottom: 40px;
        }

        .button-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 600px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border: 3px solid #000;
            cursor: pointer;
            background: #E0E0E0;
            color: #000;
            transition: all 0.2s;
            box-shadow: 4px 4px 0px #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 140px;
        }

        .btn:hover {
            background: #CCCCCC;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #666;
        }

        .btn:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px #666;
        }

        .btn-primary {
            background: #32CD32;
            color: #000;
        }

        .btn-primary:hover {
            background: #228B22;
        }

        .btn-secondary {
            background: #FFD700;
            color: #000;
        }

        .btn-secondary:hover {
            background: #FFA500;
        }

        .btn-danger {
            background: #FF6347;
            color: #000;
        }

        .btn-danger:hover {
            background: #FF4500;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border: 3px solid #000;
            margin-top: 15px;
            min-width: 320px;
            max-width: 450px;
            max-height: 520px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            border: 2px solid #000;
            background: white;
            box-sizing: border-box;
        }

        .message {
            padding: 10px;
            margin: 10px 0;
            border: 2px solid;
            font-weight: bold;
            text-align: center;
        }

        .success {
            background: #90EE90;
            border-color: #00FF00;
            color: #006400;
        }

        .error {
            background: #FFB6C1;
            border-color: #FF0000;
            color: #8B0000;
        }

        .menu-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .user-info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #FFD700;
            font-weight: bold;
            font-size: 18px;
        }

        .game-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            display: none;
        }

        .bird {
            position: absolute;
            width: 19px;
            height: 16px;
            z-index: 20;
            transition: transform 0.1s ease;
            border: 2px solid #000;
        }
        
        .bird.char0 {
            background: linear-gradient(45deg, #FFD700 25%, #FFA500 25%, #FFA500 50%, #FFD700 50%, #FFD700 75%, #FFA500 75%);
            background-size: 4px 4px;
        }
        
        .bird.char1 {
            background: linear-gradient(45deg, #8B4513 25%, #A0522D 25%, #A0522D 50%, #8B4513 50%, #8B4513 75%, #A0522D 75%);
            background-size: 4px 4px;
        }
        
        .bird.char2 {
            background: linear-gradient(45deg, #32CD32 25%, #228B22 25%, #228B22 50%, #32CD32 50%, #32CD32 75%, #228B22 75%);
            background-size: 4px 4px;
        }
        
        .bird.char3 {
            background: linear-gradient(45deg, #4169E1 25%, #1E90FF 25%, #1E90FF 50%, #4169E1 50%, #4169E1 75%, #1E90FF 75%);
            background-size: 4px 4px;
        }

        /* Beak */
        .bird::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 3px;
            width: 0;
            height: 0;
            border-left: 8px solid #FF8C00;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            z-index: 21;
        }
        
        .bird.char1::after {
            border-left-color: #654321;
        }
        
        .bird.char2::after {
            border-left-color: #FFA500;
        }
        
        .bird.char3::after {
            border-left-color: #FF6347;
        }

        /* Wings */
        .bird::before {
            content: '';
            position: absolute;
            left: -3px;
            top: 2px;
            width: 8px;
            height: 10px;
            border: 2px solid #000;
            z-index: 19;
        }
        
        .bird.char0::before {
            background: linear-gradient(45deg, #FFA500 25%, #FF8C00 25%, #FF8C00 50%, #FFA500 50%, #FFA500 75%, #FF8C00 75%);
            background-size: 2px 2px;
        }
        
        .bird.char1::before {
            background: linear-gradient(45deg, #A0522D 25%, #8B4513 25%, #8B4513 50%, #A0522D 50%, #A0522D 75%, #8B4513 75%);
            background-size: 2px 2px;
        }
        
        .bird.char2::before {
            background: linear-gradient(45deg, #228B22 25%, #006400 25%, #006400 50%, #228B22 50%, #228B22 75%, #006400 75%);
            background-size: 2px 2px;
        }
        
        .bird.char3::before {
            background: linear-gradient(45deg, #1E90FF 25%, #0000CD 25%, #0000CD 50%, #1E90FF 50%, #1E90FF 75%, #0000CD 75%);
            background-size: 2px 2px;
        }

        .obstacle {
            position: absolute;
            background: linear-gradient(to right, #228B22, #32CD32, #228B22);
            border: 3px solid #006400;
            border-radius: 8px;
            z-index: 15;
            box-shadow: inset 2px 0 4px rgba(255,255,255,0.3), inset -2px 0 4px rgba(0,0,0,0.3), 4px 4px 8px rgba(0,0,0,0.4);
        }
        
        .obstacle::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -4px;
            right: -4px;
            height: 16px;
            background: linear-gradient(to right, #006400, #228B22, #006400);
            border: 2px solid #004400;
            border-radius: 6px;
        }
        
        .obstacle::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: -4px;
            right: -4px;
            height: 16px;
            background: linear-gradient(to right, #006400, #228B22, #006400);
            border: 2px solid #004400;
            border-radius: 6px;
        }
        
        .obstacle.bottom {
            border-bottom: none;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .obstacle.bottom::after {
            display: none;
        }

        .score {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.3);
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #FFD700;
            z-index: 25;
        }
        
        .coin-display {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.4);
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #FFD700;
            z-index: 25;
        }
        
        .coin-display::before {
            content: 'üí∞ ';
            font-size: 18px;
        }
        
        .sign-out-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border: 2px solid #FF4444;
            cursor: pointer;
            background: #FF6666;
            color: #000;
            border-radius: 6px;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            z-index: 25;
        }
        
        .sign-out-btn:hover {
            background: #FF4444;
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .time {
            position: absolute;
            top: 70px;
            left: 20px;
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.3);
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #FFD700;
            z-index: 25;
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border: 3px solid #000;
            text-align: center;
            z-index: 20;
        }

        .hidden {
            display: none !important;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border: 3px solid #000;
            max-width: 600px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }

        .modal-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .history-item, .leaderboard-item {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
        }

        .rank {
            font-weight: bold;
            color: #FFD700;
        }
        
        .character-selection {
            margin-top: 20px;
            text-align: center;
        }
        
        .character-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .character-card {
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #333;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .character-card:hover {
            background: rgba(255, 255, 255, 1);
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 6px rgba(0,0,0,0.4);
        }
        
        .character-card.selected {
            background: #32CD32;
            border-color: #228B22;
        }
        
        .character-card.locked {
            background: rgba(128, 128, 128, 0.5);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .character-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .character-cost {
            font-size: 14px;
            color: #FFD700;
            font-weight: bold;
        }
        
        .character-cost::before {
            content: 'üí∞ ';
        }
        
        .pause-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border: 2px solid #FFD700;
            cursor: pointer;
            background: #FFA500;
            color: #000;
            border-radius: 6px;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            z-index: 30;
        }
        
        .pause-btn:hover {
            background: #FF8C00;
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .pause-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border: 3px solid #000;
            text-align: center;
            z-index: 35;
            border-radius: 8px;
        }
        
        .pause-menu h3 {
            margin-top: 0;
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .help-text {
            text-align: left;
            margin: 15px 0;
            font-size: 14px;
            background: rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <!-- Background elements -->
        <div class="buildings" id="buildings"></div>
        <div class="clouds" id="clouds"></div>
        <div class="ground-stripes"></div>

        <!-- Authentication Screen -->
        <div class="auth-screen" id="authScreen">
            <h1 class="title">JUMPY BIRD</h1>
            
            <div id="mainAuth">
                <div class="button-group">
                    <button class="btn" onclick="showLogin()">Sign In</button>
                    <button class="btn" onclick="showSignup()">Sign Up</button>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="playAsGuest()">Play as Guest</button>
                </div>
            </div>

            <!-- Login Form -->
            <div class="form-container hidden" id="loginForm">
                <h3>Sign In</h3>
                <div id="loginMessage"></div>
                

                

                
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Login</button>
                        <button type="button" class="btn" onclick="showMain()">Back</button>
                    </div>
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="showForgotPassword()">Forgot Password?</button>
                    </div>
                </form>
            </div>

            <!-- Signup Form -->
            <div class="form-container hidden" id="signupForm">
                <h3>Create Account</h3>
                <div id="signupMessage"></div>
                <form onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" id="signupUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="signupPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password:</label>
                        <input type="password" id="signupConfirmPassword" required>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Sign Up</button>
                        <button type="button" class="btn" onclick="showMain()">Back</button>
                    </div>
                </form>
            </div>

            <!-- Forgot Password Form -->
            <div class="form-container hidden" id="forgotPasswordForm">
                <h3>Reset Password</h3>
                <div id="forgotMessage"></div>
                <form onsubmit="handleForgotPassword(event)">
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="forgotEmail" required>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Send Reset</button>
                        <button type="button" class="btn" onclick="showMain()">Back</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Menu Screen -->
        <div class="menu-screen" id="menuScreen">
            <div class="coin-display" id="coinDisplay" style="display: none;">0</div>
            <button class="sign-out-btn" id="signOutBtn" onclick="signOut()" style="display: none;">Sign Out</button>
            
            <div class="user-info" id="userInfo"></div>
            <h1 class="title">JUMPY BIRD</h1>
            <div class="button-group">
                <button class="btn btn-primary" onclick="startGame()">START</button>
            </div>
            <div class="button-group" id="userButtons">
                <button class="btn" onclick="showHistory()">Game History</button>
                <button class="btn" onclick="showLeaderboard()">Leaderboard</button>
            </div>
            
            <!-- Character Selection -->
            <div class="character-selection" id="characterSelection" style="display: none;">
                <h3>Choose Your Character</h3>
                <div class="character-grid">
                    <div class="character-card" id="char0" onclick="selectCharacter(0)">
                        <div class="character-icon">üê¶</div>
                        <div>Basic Bird</div>
                        <div class="character-cost">Free</div>
                    </div>
                    <div class="character-card locked" id="char1" onclick="selectCharacter(1)">
                        <div class="character-icon">ü¶Ö</div>
                        <div>Eagle</div>
                        <div class="character-cost">50</div>
                    </div>
                    <div class="character-card locked" id="char2" onclick="selectCharacter(2)">
                        <div class="character-icon">ü¶ú</div>
                        <div>Parrot</div>
                        <div class="character-cost">100</div>
                    </div>
                    <div class="character-card locked" id="char3" onclick="selectCharacter(3)">
                        <div class="character-icon">ü¶Ü</div>
                        <div>Duck</div>
                        <div class="character-cost">200</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <div class="score" id="gameScore">Score: 0</div>
            <div class="time" id="gameTime">Time: 0s</div>
            <button class="pause-btn" id="pauseBtn" onclick="togglePause()">Pause</button>
            <div id="bird" class="bird"></div>
            <div id="obstacles"></div>
            
            <div class="pause-menu hidden" id="pauseMenu">
                <h3>Game Paused</h3>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="resumeGame()">Resume</button>
                    <button class="btn" onclick="restartGame()">Restart</button>
                </div>
                <div class="button-group">
                    <button class="btn" onclick="showHelp()">Help</button>
                    <button class="btn" onclick="backToMenu()">Main Menu</button>
                </div>
                <div class="help-text hidden" id="helpText">
                    <strong>Controls:</strong><br>
                    ‚Ä¢ Press SPACEBAR to jump<br>
                    ‚Ä¢ Avoid the green pillars<br>
                    ‚Ä¢ Score points by passing through gaps<br>
                    ‚Ä¢ Press PAUSE to pause the game
                </div>
            </div>
            
            <div class="game-over hidden" id="gameOver">
                <h2>Game Over!</h2>
                <p id="finalScore">Score: 0</p>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="restartGame()">Play Again</button>
                    <button class="btn" onclick="backToMenu()">Menu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Sign-In API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script>
        let currentUser = null;
        let isGuest = false;
        let gameState = 'auth';
        let gameRunning = false;
        let bird = { x: 100, y: 300, velocity: 0 };
        let obstacles = [];
        let score = 0;
        let gameStartTime = 0;
        let gameTime = 0;
        let obstacleTimer = 0;
        let obstacleSpacing = 400;
        let lastObstacleX = 800;
        let gameHistory = [];
        let gameStarted = false;
        let selectedCharacter = 0;
        let unlockedCharacters = [true, false, false, false]; // Basic bird is free, will be loaded from server
        let gamePaused = false;
        let pauseStartTime = 0;

        // Initialize background elements
        function initBackground() {
            // Create buildings with varied heights
            const buildingsContainer = document.getElementById('buildings');
            const buildingHeights = [180, 140, 220, 160, 200, 150, 250, 170, 190];
            for (let i = 0; i < 9; i++) {
                const building = document.createElement('div');
                building.className = 'building';
                building.style.left = (i * 88.9) + 'px';
                building.style.width = '88.9px';
                building.style.height = buildingHeights[i] + 'px';
                buildingsContainer.appendChild(building);
            }

            // Create clouds
            const cloudsContainer = document.getElementById('clouds');
            for (let i = 0; i < 6; i++) {
                const cloud = document.createElement('div');
                cloud.className = 'cloud';
                cloud.style.left = (i * 150) + 'px';
                cloud.style.top = (50 + (i % 3) * 40) + 'px';
                const size = 30 + (i % 2) * 10;
                cloud.style.width = size + 'px';
                cloud.style.height = size + 'px';
                cloudsContainer.appendChild(cloud);
            }
        }

        // Authentication functions
        function showLogin() {
            document.getElementById('mainAuth').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function showSignup() {
            document.getElementById('mainAuth').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }

        function showForgotPassword() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.remove('hidden');
        }

        function showMain() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            document.getElementById('mainAuth').classList.remove('hidden');
            clearMessages();
        }

        function clearMessages() {
            document.getElementById('loginMessage').innerHTML = '';
            document.getElementById('signupMessage').innerHTML = '';
            document.getElementById('forgotMessage').innerHTML = '';
        }
        
        // Global function for clearing single message (fixes undefined error)
        function clearMessage(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = '';
            }
        }

        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${isError ? 'error' : 'success'}">${message}</div>`;
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                if (result.success) {
                    currentUser = result.user;
                    isGuest = false;
                    
                    // Load character unlocks and refresh coins from server
                    await loadUserUnlocks();
                    await refreshCoinsFromServer();
                    
                    showMenu();
                } else {
                    showMessage('loginMessage', result.message, true);
                }
            } catch (error) {
                showMessage('loginMessage', 'Network error occurred', true);
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const username = document.getElementById('signupUsername').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            try {
                const response = await fetch('/api/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, username, password, confirm_password: confirmPassword })
                });

                const result = await response.json();
                showMessage('signupMessage', result.message, !result.success);
            } catch (error) {
                showMessage('signupMessage', 'Network error occurred', true);
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            const email = document.getElementById('forgotEmail').value;

            try {
                const response = await fetch('/api/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const result = await response.json();
                showMessage('forgotMessage', result.message, !result.success);
            } catch (error) {
                showMessage('forgotMessage', 'Network error occurred', true);
            }
        }

        async function playAsGuest() {
            try {
                const response = await fetch('/api/guest-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                if (result.success) {
                    isGuest = true;
                    currentUser = null;
                    showMenu();
                }
            } catch (error) {
                console.error('Guest login failed');
            }
        }

        function showMenu() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('menuScreen').style.display = 'flex';
            
            if (isGuest) {
                document.getElementById('userInfo').textContent = 'Playing as Guest';
                document.getElementById('userButtons').style.display = 'none';
                document.getElementById('coinDisplay').style.display = 'none';
                document.getElementById('signOutBtn').style.display = 'block'; // Show sign out for guests
                document.getElementById('characterSelection').style.display = 'none';
            } else {
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('userButtons').style.display = 'block';
                document.getElementById('coinDisplay').style.display = 'block';
                document.getElementById('coinDisplay').textContent = currentUser.coins;
                document.getElementById('signOutBtn').style.display = 'block';
                document.getElementById('characterSelection').style.display = 'block';
                updateCharacterDisplay();
            }
            
            gameState = 'menu';
        }
        
        function updateCharacterDisplay() {
            const characterCosts = [0, 50, 100, 150, 200];
            for (let i = 0; i < 4; i++) {
                const charCard = document.getElementById(`char${i}`);
                const costElement = charCard.querySelector('.character-cost');
                const canAfford = currentUser.coins >= characterCosts[i];
                const isUnlocked = unlockedCharacters[i];
                
                // Hide cost text for unlocked characters
                if (isUnlocked) {
                    charCard.classList.remove('locked');
                    costElement.style.display = 'none';
                } else if (canAfford) {
                    charCard.classList.remove('locked');
                    costElement.style.display = 'block';
                } else {
                    charCard.classList.add('locked');
                    costElement.style.display = 'block';
                }
                
                if (selectedCharacter === i) {
                    charCard.classList.add('selected');
                } else {
                    charCard.classList.remove('selected');
                }
            }
        }
        
        function selectCharacter(characterIndex) {
            if (isGuest) return;
            
            const characterCosts = [0, 50, 100, 150, 200];
            const cost = characterCosts[characterIndex];
            
            // If already unlocked, just select it
            if (unlockedCharacters[characterIndex]) {
                selectedCharacter = characterIndex;
                updateCharacterDisplay();
                updateBirdAppearance();
                return;
            }
            
            // If can afford to unlock
            if (currentUser.coins >= cost) {
                console.log(`[CHARACTER DEBUG] Purchasing character ${characterIndex} for ${cost} coins`);
                
                // Use server API to unlock character
                unlockCharacterOnServer(characterIndex, cost);
            }
        }
        
        function updateBirdAppearance() {
            const birdElement = document.getElementById('bird');
            // Remove existing character classes
            birdElement.className = 'bird';
            // Add new character class
            birdElement.classList.add(`char${selectedCharacter}`);
            
            // Apply rotation based on velocity
            if (bird.velocity > 2) {
                birdElement.style.transform = 'rotate(15deg)'; // Falling down
            } else if (bird.velocity < -2) {
                birdElement.style.transform = 'rotate(-15deg)'; // Flying up
            } else {
                birdElement.style.transform = 'rotate(0deg)'; // Neutral
            }
        }
        
        async function saveCoinsToServer() {
            if (isGuest) return;
            
            try {
                await fetch('/api/update-coins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ coins: currentUser.coins })
                });
            } catch (error) {
                console.error('Failed to save coins');
            }
        }

        async function unlockCharacterOnServer(characterIndex, cost) {
            if (isGuest) return;
            
            try {
                const response = await fetch('/api/unlock-character', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        character_id: characterIndex, 
                        cost: cost 
                    })
                });
                
                const result = await response.json();
                console.log(`[CHARACTER DEBUG] Server response:`, result);
                
                if (result.success) {
                    // Update coins from server
                    currentUser.coins = result.coins;
                    document.getElementById('coinDisplay').textContent = currentUser.coins;
                    
                    // Update local unlocks
                    unlockedCharacters[characterIndex] = true;
                    selectedCharacter = characterIndex;
                    
                    updateCharacterDisplay();
                    updateBirdAppearance();
                } else {
                    alert(result.message || 'Failed to unlock character');
                }
            } catch (error) {
                console.error('Failed to unlock character on server');
                alert('Failed to unlock character');
            }
        }

        function startGame() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            gameState = 'game';
            initGame();
        }

        function initGame() {
            bird = { x: 100, y: 300, velocity: 0 };
            obstacles = [];
            score = 0;
            gameStartTime = 0; // Don't start timing until first jump
            gameTime = 0;
            gameRunning = true;
            gameStarted = false;
            gamePaused = false;
            obstacleTimer = 0;
            obstacleSpacing = 400;
            lastObstacleX = 800;
            
            document.getElementById('gameScore').textContent = `Score: ${score}`;
            document.getElementById('gameTime').textContent = `Time: 0s`;
            document.getElementById('gameOver').classList.add('hidden');
            document.getElementById('pauseMenu').classList.add('hidden');
            document.querySelector('.ground-stripes').classList.add('paused');
            
            // Clear any existing obstacles
            document.getElementById('obstacles').innerHTML = '';
            
            updateBirdAppearance();
            updateBirdPosition();
            gameLoop();
        }

        function updateBirdPosition() {
            const birdElement = document.getElementById('bird');
            birdElement.style.left = bird.x + 'px';
            birdElement.style.top = bird.y + 'px';
        }

        function gameLoop() {
            if (!gameRunning || gamePaused) {
                if (gameRunning) requestAnimationFrame(gameLoop);
                return;
            }

            if (gameStarted) {
                // Update game time only after game has started
                if (gameStartTime > 0) {
                    gameTime = (Date.now() - gameStartTime) / 1000;
                    document.getElementById('gameTime').textContent = `Time: ${Math.floor(gameTime)}s`;
                }
                
                // Calculate dynamic obstacle spacing using the formula
                obstacleSpacing = Math.max(400 - (gameTime * 5), 200);

                // Update bird physics - simple and reliable
                bird.velocity += 0.5; // gravity
                bird.y += bird.velocity;

                // Check boundaries
                if (bird.y <= 0 || bird.y >= 500 - 16) {
                    endGame();
                    return;
                }

                updateBirdPosition();
                updateBirdAppearance(); // Update rotation based on velocity

                // Generate obstacles with consistent timing
                obstacleTimer++;
                if (obstacleTimer >= obstacleSpacing / 4) {
                    createObstacle();
                    obstacleTimer = 0;
                }

                // Update obstacles
                updateObstacles();
            } else {
                // Before game starts, keep bird stationary and update appearance
                updateBirdAppearance();
            }

            requestAnimationFrame(gameLoop);
        }

        function createObstacle() {
            // Ensure proper positioning - gap should be within flying area (not in ground)
            const flyingAreaHeight = 500 - 100; // 500px total - 100px ground = 400px flying area
            const gapSize = 160 - Math.random() * 20; // 140-160px gap
            const gapY = 100 + Math.random() * (flyingAreaHeight - gapSize - 50); // Keep gap away from ground and top
            
            // Only create obstacle if there's proper spacing from last one
            if (800 - lastObstacleX >= obstacleSpacing || obstacles.length === 0) {
                obstacles.push({
                    x: 800,
                    topHeight: gapY,
                    bottomY: gapY + gapSize,
                    bottomHeight: 500 - (gapY + gapSize),
                    scored: false
                });
                
                lastObstacleX = 800;
                updateObstacleDisplay();
            }
        }

        function updateObstacles() {
            let collisionDetected = false;
            
            obstacles = obstacles.filter(obstacle => {
                obstacle.x -= 4; // Consistent obstacle movement

                // Update lastObstacleX to track the rightmost obstacle
                if (obstacle.x > lastObstacleX - 800) {
                    lastObstacleX = obstacle.x;
                }

                // Check scoring
                if (!obstacle.scored && bird.x > obstacle.x + 50) {
                    obstacle.scored = true;
                    score++;
                    document.getElementById('gameScore').textContent = `Score: ${score}`;
                }

                // Check collision with proper boundaries
                if (gameRunning && bird.x < obstacle.x + 50 && bird.x + 19 > obstacle.x) {
                    if (bird.y < obstacle.topHeight || bird.y + 16 > obstacle.bottomY) {
                        collisionDetected = true;
                    }
                }

                return obstacle.x > -50;
            });

            // Handle collision after filtering to keep obstacles visible
            if (collisionDetected) {
                endGame();
            }

            updateObstacleDisplay();
        }

        function updateObstacleDisplay() {
            const container = document.getElementById('obstacles');
            container.innerHTML = '';

            obstacles.forEach(obstacle => {
                // Top pillar
                const topPillar = document.createElement('div');
                topPillar.className = 'obstacle';
                topPillar.style.left = obstacle.x + 'px';
                topPillar.style.top = '0px';
                topPillar.style.width = '50px';
                topPillar.style.height = obstacle.topHeight + 'px';
                container.appendChild(topPillar);

                // Bottom pillar
                const bottomPillar = document.createElement('div');
                bottomPillar.className = 'obstacle bottom';
                bottomPillar.style.left = obstacle.x + 'px';
                bottomPillar.style.top = obstacle.bottomY + 'px';
                bottomPillar.style.width = '50px';
                bottomPillar.style.height = obstacle.bottomHeight + 'px';
                container.appendChild(bottomPillar);
            });
        }

        function jump() {
            if (gameRunning && !gamePaused) {
                if (!gameStarted) {
                    // First jump starts the game
                    gameStarted = true;
                    gameStartTime = Date.now();
                    document.querySelector('.ground-stripes').classList.remove('paused');
                }
                bird.velocity = -9; // Jump strength remains constant regardless of frame rate
            }
        }
        
        function togglePause() {
            if (!gameRunning) return;
            
            gamePaused = !gamePaused;
            
            if (gamePaused) {
                document.getElementById('pauseMenu').classList.remove('hidden');
                document.getElementById('pauseBtn').textContent = 'Resume';
                // Pause ground animation
                document.querySelector('.ground-stripes').classList.add('paused');
            } else {
                document.getElementById('pauseMenu').classList.add('hidden');
                document.getElementById('pauseBtn').textContent = 'Pause';
                // Resume ground animation only if game has started
                if (gameStarted) {
                    document.querySelector('.ground-stripes').classList.remove('paused');
                }
                // Adjust game start time to account for pause duration
                gameStartTime += Date.now() - pauseStartTime;
            }
            
            if (gamePaused) {
                pauseStartTime = Date.now();
            }
        }
        
        function resumeGame() {
            if (gamePaused) {
                togglePause();
            }
        }
        
        function showHelp() {
            const helpText = document.getElementById('helpText');
            helpText.classList.toggle('hidden');
        }

        async function endGame() {
            gameRunning = false;
            
            // Stop ground animation
            document.querySelector('.ground-stripes').classList.add('paused');
            
            document.getElementById('finalScore').textContent = `Score: ${score}`;
            document.getElementById('gameOver').classList.remove('hidden');

            // Save score for authenticated users
            if (!isGuest && currentUser) {
                const playTime = Math.floor((Date.now() - gameStartTime) / 1000);
                const currentDate = new Date().toISOString().slice(0, 19).replace('T', ' ');
                
                // Add game to local history for test account
                if (currentUser.username === 'TestPlayer') {
                    gameHistory.unshift({
                        score: score,
                        play_time: playTime,
                        played_at: currentDate
                    });
                    
                    // Keep only last 10 games
                    if (gameHistory.length > 10) {
                        gameHistory = gameHistory.slice(0, 10);
                    }
                    
                    // Note: Coins will be updated from server response
                }
                
                try {
                    console.log(`[COIN DEBUG] Saving score: ${score}`);
                    
                    const response = await fetch('/api/save-score', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ score, play_time: playTime })
                    });

                    const result = await response.json();
                    console.log(`[COIN DEBUG] Score save response:`, result);
                    
                    if (result.success && result.coins !== undefined) {
                        currentUser.coins = result.coins;
                        console.log(`[COIN DEBUG] Updated coins to: ${result.coins}`);
                        
                        // Update coin display
                        if (document.getElementById('coinDisplay')) {
                            document.getElementById('coinDisplay').textContent = currentUser.coins;
                        }
                    }
                } catch (error) {
                    console.error('Failed to save score');
                }
            }
        }

        function restartGame() {
            initGame();
        }

        function backToMenu() {
            document.getElementById('gameScreen').style.display = 'none';
            showMenu();
            updateUserInfo(); // Update coin display
        }

        function updateUserInfo() {
            if (!isGuest && currentUser) {
                document.getElementById('userInfo').textContent = `Welcome, ${currentUser.username}! Coins: ${currentUser.coins}`;
            }
        }

        async function refreshCoinsFromServer() {
            if (isGuest) return;
            
            try {
                const response = await fetch('/api/get-coins');
                const result = await response.json();
                
                if (result.success) {
                    currentUser.coins = result.coins;
                    console.log(`[COIN DEBUG] Refreshed coins from server: ${result.coins}`);
                    
                    // Update display
                    if (document.getElementById('coinDisplay')) {
                        document.getElementById('coinDisplay').textContent = currentUser.coins;
                    }
                }
            } catch (error) {
                console.error('Failed to refresh coins');
            }
        }

        async function loadUserUnlocks() {
            if (isGuest) return;
            
            try {
                const response = await fetch('/api/get-unlocks');
                const result = await response.json();
                
                if (result.success) {
                    // Reset to defaults (character 0 is always unlocked)
                    unlockedCharacters = [true, false, false, false];
                    
                    // Set unlocked characters from server
                    result.unlocked_characters.forEach(charId => {
                        if (charId >= 0 && charId < 4) {
                            unlockedCharacters[charId] = true;
                        }
                    });
                    
                    console.log('[CHARACTER DEBUG] Loaded unlocks:', unlockedCharacters);
                }
            } catch (error) {
                console.error('Failed to load character unlocks');
            }
        }

        async function signOut() {
            try {
                await fetch('/api/logout', { method: 'POST' });
            } catch (error) {
                console.error('Logout failed');
            }

            currentUser = null;
            isGuest = false;
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('authScreen').classList.remove('hidden');
            showMain();
            gameState = 'auth';
        }

        async function showHistory() {
            if (isGuest) {
                alert('History is only available for registered users');
                return;
            }

            // For test account, show actual game history
            if (currentUser && currentUser.username === 'TestPlayer') {
                displayHistoryModal(gameHistory);
                return;
            }

            try {
                const response = await fetch('/api/history');
                const result = await response.json();
                
                if (result.success) {
                    displayHistoryModal(result.history);
                } else {
                    // Fallback to sample data if API fails
                    const sampleHistory = [
                        { score: 15, play_time: 45, played_at: '2025-06-26 07:00:00' },
                        { score: 23, play_time: 78, played_at: '2025-06-26 06:45:00' },
                        { score: 8, play_time: 22, played_at: '2025-06-26 06:30:00' }
                    ];
                    displayHistoryModal(sampleHistory);
                }
            } catch (error) {
                const sampleHistory = [
                    { score: 15, play_time: 45, played_at: '2025-06-26 07:00:00' },
                    { score: 23, play_time: 78, played_at: '2025-06-26 06:45:00' },
                    { score: 8, play_time: 22, played_at: '2025-06-26 06:30:00' }
                ];
                displayHistoryModal(sampleHistory);
            }
        }

        async function showLeaderboard() {
            if (isGuest) {
                alert('Leaderboard is only available for registered users');
                return;
            }

            // For test account, show sample leaderboard directly
            if (currentUser && currentUser.username === 'TestPlayer') {
                const sampleLeaderboard = [
                    ['JumpyMaster', 89],
                    ['BirdNinja', 76], 
                    ['SkyDancer', 65],
                    ['TestPlayer', 31],
                    ['WingCommander', 28],
                    ['SkyPilot', 24],
                    ['CloudJumper', 19],
                    ['FeatherFly', 16]
                ];
                displayLeaderboardModal(sampleLeaderboard, 4);
                return;
            }

            try {
                const response = await fetch('/api/leaderboard');
                const result = await response.json();
                
                if (result.success) {
                    displayLeaderboardModal(result.leaderboard, result.user_rank);
                } else {
                    const sampleLeaderboard = [
                        ['JumpyMaster', 89],
                        ['BirdNinja', 76], 
                        ['SkyDancer', 65],
                        ['TestPlayer', 31],
                        ['WingCommander', 28]
                    ];
                    displayLeaderboardModal(sampleLeaderboard, 4);
                }
            } catch (error) {
                const sampleLeaderboard = [
                    ['JumpyMaster', 89],
                    ['BirdNinja', 76], 
                    ['SkyDancer', 65],
                    ['TestPlayer', 31],
                    ['WingCommander', 28]
                ];
                displayLeaderboardModal(sampleLeaderboard, 4);
            }
        }

        // Event listeners
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space') {
                event.preventDefault();
                if (gameState === 'game') {
                    jump();
                }
            }
        });

        document.addEventListener('click', function(event) {
            if (gameState === 'game' && gameRunning) {
                jump();
            }
        });

        // Sign out function for both guest and signed-in users
        function signOut() {
            // Reset user state
            currentUser = null;
            isGuest = false;
            gameHistory = [];
            selectedCharacter = 0;
            unlockedCharacters = [true, false, false, false];
            
            // Reset game state
            gameRunning = false;
            gameStarted = false;
            gamePaused = false;
            
            // Hide all screens and show auth screen
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('authScreen').classList.remove('hidden');
            
            // Reset game state
            gameState = 'auth';
            
            // Clear any messages
            const loginMsg = document.getElementById('loginMessage');
            const signupMsg = document.getElementById('signupMessage');
            const forgotMsg = document.getElementById('forgotMessage');
            if (loginMsg) loginMsg.textContent = '';
            if (signupMsg) signupMsg.textContent = '';
            if (forgotMsg) forgotMsg.textContent = '';
        }





        function displayHistoryModal(history) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.onclick = function(e) {
                if (e.target === modal) closeModal(modal);
            };

            let historyHTML = `
                <div class="modal-content">
                    <div class="modal-header">Game History</div>
                    <div style="margin-bottom: 20px;">
            `;

            if (history.length === 0) {
                historyHTML += '<p>No games played yet!</p>';
            } else {
                history.forEach((game, index) => {
                    const date = new Date(game.played_at).toLocaleDateString();
                    const time = new Date(game.played_at).toLocaleTimeString();
                    historyHTML += `
                        <div class="history-item">
                            <div>
                                <strong>Score: ${game.score}</strong><br>
                                <small>${date} ${time}</small>
                            </div>
                            <div>
                                Play Time: ${game.play_time}s
                            </div>
                        </div>
                    `;
                });
            }

            historyHTML += `
                    </div>
                    <button class="btn" onclick="closeModal(this.closest('.modal'))">Close</button>
                </div>
            `;

            modal.innerHTML = historyHTML;
            document.body.appendChild(modal);
        }

        function displayLeaderboardModal(leaderboard, userRank) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.onclick = function(e) {
                if (e.target === modal) closeModal(modal);
            };

            let leaderboardHTML = `
                <div class="modal-content">
                    <div class="modal-header">Leaderboard</div>
                    <div style="margin-bottom: 20px;">
                        ${userRank ? `<p style="text-align: center; color: #4285f4;"><strong>Your Rank: #${userRank}</strong></p>` : ''}
            `;

            if (leaderboard.length === 0) {
                leaderboardHTML += '<p>No scores recorded yet!</p>';
            } else {
                leaderboard.forEach((player, index) => {
                    const rankClass = index < 3 ? 'rank' : '';
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                    leaderboardHTML += `
                        <div class="leaderboard-item ${rankClass}">
                            <div>
                                ${medal} #${index + 1} ${player[0]}
                            </div>
                            <div>
                                <strong>${player[1]} points</strong>
                            </div>
                        </div>
                    `;
                });
            }

            leaderboardHTML += `
                    </div>
                    <button class="btn" onclick="closeModal(this.closest('.modal'))">Close</button>
                </div>
            `;

            modal.innerHTML = leaderboardHTML;
            document.body.appendChild(modal);
        }

        function closeModal(modal) {
            modal.remove();
        }

        // Initialize
        initBackground();
    </script>
</body>
</html>